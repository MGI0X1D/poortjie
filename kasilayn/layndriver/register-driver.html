<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Become a Driver | Poortjie Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="icon" type="image/png" sizes="48x48" href="../../favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicon/apple-touch-icon.png">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../../scripts/firebase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="../../scripts/theme.js" defer></script>
</head>
<body class="font-sans antialiased bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">

<header class="max-w-4xl mx-auto pt-10 pb-6 px-6 flex justify-between items-center">
    <div class="flex items-center gap-4">
        <button onclick="history.back()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-xl font-black uppercase tracking-tight">Join the Fleet</h1>
    </div>
    <div class="flex items-center gap-3">
        <!-- Commission Info Icon -->
        <div class="relative group">
            <button class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center transition-all hover:scale-110 shadow-sm">
                <i class="fas fa-info-circle"></i>
            </button>
            <div class="absolute right-0 top-10 w-64 p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-slate-100 dark:border-slate-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-all duration-300 z-[60] -translate-y-2 group-hover:translate-y-0">
                <p class="text-[10px] font-black uppercase tracking-widest text-blue-600 mb-2">Zero Commission Policy</p>
                <p class="text-xs font-bold leading-relaxed opacity-70">There is no charge for using the Poortjie platform. Drivers get to keep <span class="text-green-600">100% of their earnings</span>.</p>
            </div>
        </div>
        
        <div id="hamburger-menu" class="relative z-50">
            <button id="hamburger-btn" class="p-3 rounded-full bg-green-600 text-white shadow-lg hover:bg-green-700 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <div id="menu-items" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl py-2 ring-1 ring-black ring-opacity-5 border border-slate-100 dark:border-slate-700">
                <button id="menu-theme-toggle" class="w-full text-left px-4 py-2 text-xs font-bold uppercase tracking-widest text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-3">
                    <span id="menu-theme-icon">ðŸŒ“</span> Mode
                </button>
                <div class="border-t border-gray-100 dark:border-slate-700 my-1"></div>
                <a href="../../index.html" class="block w-full text-left px-4 py-2 text-xs font-bold uppercase tracking-widest text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-3">
                    <i class="fas fa-home w-4 text-center"></i> Home
                </a>
                <button id="logout-btn" class="w-full text-left px-4 py-2 text-xs font-bold uppercase tracking-widest text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3">
                    <i class="fas fa-sign-out-alt w-4 text-center"></i> Logout
                </button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-4xl mx-auto px-6 pb-24">
    <div id="loader-overlay" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 z-[100] flex flex-col items-center justify-center transition-opacity duration-300 hidden">
        <div class="animate-spin h-10 w-10 border-4 border-green-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-sm font-bold uppercase tracking-widest animate-pulse" id="loader-text">Processing...</p>
    </div>

    <div class="card p-8 rounded-[2.5rem] bg-white dark:bg-slate-800 shadow-xl space-y-8">
        <div id="status-message" class="hidden p-4 rounded-2xl text-sm font-bold border-2 animate-fadeIn"></div>

        <!-- Development Warning -->
        <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r-2xl mb-6">
            <div class="flex items-center gap-3">
                <i class="fas fa-tools text-red-600 dark:text-red-400"></i>
                <p class="text-[10px] font-black uppercase tracking-widest text-red-700 dark:text-red-400">
                    System Notice: This feature is still under development.
                </p>
            </div>
        </div>

        <form id="driver-form" class="space-y-8">
            <!-- Driver Info Section -->
            <section class="space-y-6">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-4 bg-green-500 rounded-full"></span>
                    <h2 class="text-[10px] font-black uppercase tracking-widest opacity-40">Driver Information</h2>
                </div>

                <div class="flex flex-col sm:flex-row gap-6 items-center">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('photo-input').click()">
                        <img id="driver-preview" src="https://placehold.co/150?text=Driver+Photo" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-green-500 shadow-md">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="fas fa-camera text-white"></i>
                        </div>
                        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="previewImage(this, 'driver-preview')">
                    </div>
                    <div class="flex-grow space-y-4 w-full">
                        <div>
                            <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Full Name</label>
                            <input type="text" id="display-name" required placeholder="Enter your full name" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Car Info Section -->
            <section class="space-y-6 pt-6 border-t border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-4 bg-green-500 rounded-full"></span>
                    <h2 class="text-[10px] font-black uppercase tracking-widest opacity-40">Vehicle Details</h2>
                </div>
                
                <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-4 rounded-r-2xl" id="car-edit-warning">
                    <p class="text-[10px] font-bold text-amber-700 dark:text-amber-400 uppercase tracking-wider">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Important: Car details cannot be changed later for safety reasons. Please ensure all information is accurate.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Make</label>
                        <input type="text" id="car-make" required placeholder="e.g. Toyota" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Model</label>
                        <input type="text" id="car-model" required placeholder="e.g. Corolla" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Registration Number</label>
                        <input type="text" id="car-registration" required placeholder="e.g. FGP123GP" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition uppercase">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Color</label>
                        <input type="text" id="car-color" required placeholder="e.g. White" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Body Type</label>
                        <select id="car-body-type" required class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition appearance-none">
                            <option value="SEDAN">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="HATCHBACK">Hatchback</option>
                            <option value="BAKKIE">Bakkie</option>
                            <option value="MINIVAN">Minivan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Available Seats</label>
                        <input type="number" id="car-seats" required min="1" max="22" value="4" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Year of Manufacture</label>
                        <input type="number" id="car-year" required min="1900" max="2026" value="2024" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                </div>

                <div class="space-y-4 pt-4">
                    <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Vehicle Photos (Up to 3)</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <!-- Photo 1 -->
                        <div id="car-photo-1-container" class="w-full h-32 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-green-500 transition group relative overflow-hidden" onclick="document.getElementById('car-photo-1-input').click()">
                            <img id="car-preview-1" class="hidden w-full h-full object-cover rounded-2xl">
                            <div id="car-upload-placeholder-1" class="flex flex-col items-center">
                                <i class="fas fa-car text-xl opacity-20 group-hover:text-green-500 transition"></i>
                                <p class="text-[8px] font-black uppercase tracking-widest opacity-40 mt-1">Photo 1</p>
                            </div>
                            <input type="file" id="car-photo-1-input" accept="image/*" class="hidden" onchange="previewImage(this, 'car-preview-1', 'car-upload-placeholder-1')">
                        </div>
                        <!-- Photo 2 -->
                        <div id="car-photo-2-container" class="w-full h-32 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-green-500 transition group relative overflow-hidden" onclick="document.getElementById('car-photo-2-input').click()">
                            <img id="car-preview-2" class="hidden w-full h-full object-cover rounded-2xl">
                            <div id="car-upload-placeholder-2" class="flex flex-col items-center">
                                <i class="fas fa-car text-xl opacity-20 group-hover:text-green-500 transition"></i>
                                <p class="text-[8px] font-black uppercase tracking-widest opacity-40 mt-1">Photo 2</p>
                            </div>
                            <input type="file" id="car-photo-2-input" accept="image/*" class="hidden" onchange="previewImage(this, 'car-preview-2', 'car-upload-placeholder-2')">
                        </div>
                        <!-- Photo 3 -->
                        <div id="car-photo-3-container" class="w-full h-32 rounded-2xl bg-slate-50 dark:bg-slate-900/50 border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center gap-2 cursor-pointer hover:border-green-500 transition group relative overflow-hidden" onclick="document.getElementById('car-photo-3-input').click()">
                            <img id="car-preview-3" class="hidden w-full h-full object-cover rounded-2xl">
                            <div id="car-upload-placeholder-3" class="flex flex-col items-center">
                                <i class="fas fa-car text-xl opacity-20 group-hover:text-green-500 transition"></i>
                                <p class="text-[8px] font-black uppercase tracking-widest opacity-40 mt-1">Photo 3</p>
                            </div>
                            <input type="file" id="car-photo-3-input" accept="image/*" class="hidden" onchange="previewImage(this, 'car-preview-3', 'car-upload-placeholder-3')">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pricing Section -->
            <section class="space-y-6 pt-6 border-t border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-2">
                    <span class="w-1 h-4 bg-green-500 rounded-full"></span>
                    <h2 class="text-[10px] font-black uppercase tracking-widest opacity-40">Dynamic Pricing Structure</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Base Fee (R)</label>
                        <input type="number" id="base-fee" required min="0" value="15" step="0.01" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Rate per KM (R)</label>
                        <input type="number" id="rate-km" required min="0" value="10" step="0.01" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-green-500 rounded-2xl px-5 py-3 text-sm font-bold outline-none transition">
                    </div>
                </div>
            </section>

            <!-- Fixed Pricing Section -->
            <section class="space-y-6 pt-6 border-t border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="w-1 h-4 bg-blue-500 rounded-full"></span>
                        <h2 class="text-[10px] font-black uppercase tracking-widest opacity-40">Fixed Pricing (Poortjie Only)</h2>
                    </div>
                    <button type="button" onclick="addFixedPricingRow()" class="text-[10px] font-black uppercase tracking-widest px-3 py-1.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-1"></i> Add Destination
                    </button>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-2xl mb-4">
                    <p class="text-[9px] font-bold text-blue-700 dark:text-blue-400 uppercase tracking-widest">
                        <i class="fas fa-map-marker-alt mr-2"></i> Pickup Point: <span class="text-blue-900 dark:text-blue-200">Poortjie</span>
                    </p>
                </div>

                <div id="fixed-pricing-container" class="space-y-3">
                    <!-- Dynamic rows will be added here -->
                </div>
            </section>

            <button type="submit" id="submit-btn" class="w-full py-5 bg-green-600 text-white text-xs font-black uppercase tracking-[0.3em] rounded-[1.5rem] shadow-xl shadow-green-500/20 transition-all active:scale-95">
                Register as Driver
            </button>
        </form>
    </div>
</main>

<script>
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Hamburger Menu Logic
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const menuItems = document.getElementById('menu-items');

        if (hamburgerBtn && menuItems) {
            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                menuItems.classList.toggle('hidden');
            });

            document.addEventListener('click', () => {
                menuItems.classList.add('hidden');
            });

            menuItems.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }

        // Logout Logic
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = '../../authentication/login.html';
                });
            });
        }

        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                window.location.href = '../../authentication/login.html';
                return;
            }
            currentUser = user;
            document.getElementById('display-name').value = user.displayName || '';
            
            // Check if already a driver
            checkDriverStatus(user.uid);
        });
    });

    async function checkDriverStatus(uid) {
        const snap = await db.collection('kasilayn').doc('fleet').collection('drivers').doc(uid).get();
        if (snap.exists) {
            showStatus("You are already registered as a driver!", "success");
            document.getElementById('submit-btn').textContent = "Update Driver Info";
            // Pre-fill existing data if needed
            const data = snap.data();
            document.getElementById('display-name').value = data.displayName || '';
            if (data.photoUrl) document.getElementById('driver-preview').src = data.photoUrl;
            
            // Support both carRegistration (string) and carRef (reference)
            let carReg = data.carRegistration;
            if (!carReg && data.carRef) {
                carReg = (typeof data.carRef === 'string') ? data.carRef : data.carRef.id;
            }

            if (carReg) {
                const carSnap = await db.collection('kasilayn').doc('fleet').collection('cars').doc(carReg).get();
                if (carSnap.exists) {
                    const carData = carSnap.data();
                    
                    const lockFieldIfPresent = (id, value) => {
                        const el = document.getElementById(id);
                        if (value && value.toString().trim() !== "") {
                            el.value = value;
                            el.disabled = true;
                        }
                    };

                    lockFieldIfPresent('car-make', carData.make);
                    lockFieldIfPresent('car-model', carData.model);
                    lockFieldIfPresent('car-registration', carData.registration);
                    lockFieldIfPresent('car-color', carData.color);
                    
                    if (carData.bodyType) {
                        document.getElementById('car-body-type').value = carData.bodyType;
                        document.getElementById('car-body-type').disabled = true;
                    }
                    
                    lockFieldIfPresent('car-seats', carData.seats);
                    lockFieldIfPresent('car-year', carData.year);

                    if (carData.pricing) {
                        document.getElementById('base-fee').value = carData.pricing.baseFee || 15;
                        document.getElementById('rate-km').value = carData.pricing.ratePerKm || 10;
                        
                        // Fill fixed pricing
                        if (carData.pricing.fixed && carData.pricing.fixed.length > 0) {
                            carData.pricing.fixed.forEach(item => {
                                addFixedPricingRow(item.destination, item.amount);
                            });
                        }
                    }
                    
                    if (carData.photoUrls && carData.photoUrls.length > 0) {
                        carData.photoUrls.forEach((url, index) => {
                            if (index < 3) {
                                const previewId = `car-preview-${index + 1}`;
                                const placeholderId = `car-upload-placeholder-${index + 1}`;
                                const containerId = `car-photo-${index + 1}-container`;
                                
                                const previewEl = document.getElementById(previewId);
                                const placeholderEl = document.getElementById(placeholderId);
                                const containerEl = document.getElementById(containerId);
                                
                                previewEl.src = url;
                                previewEl.classList.remove('hidden');
                                placeholderEl.classList.add('hidden');
                                
                                // Disable changes for present photos
                                containerEl.onclick = null;
                                containerEl.classList.remove('cursor-pointer', 'hover:border-green-500');
                            }
                        });
                    }
                    
                    // Update warning text and styling to indicate restricted editing
                    const warningEl = document.getElementById('car-edit-warning');
                    if (warningEl) {
                        warningEl.classList.replace('bg-amber-50', 'bg-blue-50');
                        warningEl.classList.replace('dark:bg-amber-900/20', 'dark:bg-blue-900/20');
                        warningEl.classList.replace('border-amber-500', 'border-blue-500');
                        warningEl.querySelector('p').classList.replace('text-amber-700', 'text-blue-700');
                        warningEl.querySelector('p').classList.replace('dark:text-amber-400', 'dark:text-blue-400');
                        warningEl.querySelector('p').innerHTML = '<i class="fas fa-info-circle mr-2"></i> Your vehicle is already registered. You may only update your pricing structure or fill in missing details.';
                    }
                }
            }
        }
    }

    function previewImage(input, previewId, placeholderId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(previewId).src = e.target.result;
                document.getElementById(previewId).classList.remove('hidden');
                if (placeholderId) document.getElementById(placeholderId).classList.add('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addFixedPricingRow(destination = "", amount = "") {
        const container = document.getElementById('fixed-pricing-container');
        const rowId = 'fixed-row-' + Date.now();
        const row = document.createElement('div');
        row.id = rowId;
        row.className = 'flex gap-3 items-end animate-fadeIn';
        row.innerHTML = `
            <div class="flex-grow">
                <label class="block text-[8px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Destination</label>
                <input type="text" name="fixed-dest" required value="${destination}" placeholder="e.g. Lenasia" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-blue-500 rounded-xl px-4 py-2 text-xs font-bold outline-none transition">
            </div>
            <div class="w-24">
                <label class="block text-[8px] font-black uppercase tracking-widest opacity-40 mb-1 ml-2">Price (R)</label>
                <input type="number" name="fixed-price" required min="1" step="0.01" value="${amount}" placeholder="500" class="w-full bg-slate-50 dark:bg-slate-900/50 border-2 border-transparent focus:border-blue-500 rounded-xl px-4 py-2 text-xs font-bold outline-none transition text-right">
            </div>
            <button type="button" onclick="document.getElementById('${rowId}').remove()" class="p-2.5 bg-red-50 text-red-600 dark:bg-red-900/20 dark:text-red-400 rounded-xl hover:bg-red-100 transition">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        container.appendChild(row);
    }

    function showStatus(msg, type) {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = msg;
        statusEl.className = `p-4 rounded-2xl text-sm font-bold border-2 animate-fadeIn ${
            type === 'success' ? 'bg-green-50 border-green-200 text-green-700 dark:bg-green-900/20 dark:border-green-800 dark:text-green-400' : 
            'bg-red-50 border-red-200 text-red-700 dark:bg-red-900/20 dark:border-red-800 dark:text-red-400'
        }`;
        statusEl.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleLoader(show, text = "Processing...") {
        const loader = document.getElementById('loader-overlay');
        document.getElementById('loader-text').textContent = text;
        if (show) {
            loader.classList.remove('hidden');
        } else {
            loader.classList.add('hidden');
        }
    }

    // Form Submission
    document.getElementById('driver-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;

        toggleLoader(true, "Promoting to Driver...");

        const carMake = document.getElementById('car-make').value;
        const carModel = document.getElementById('car-model').value;
        const carReg = document.getElementById('car-registration').value.toUpperCase();
        const carColor = document.getElementById('car-color').value;
        const carBodyType = document.getElementById('car-body-type').value.toUpperCase();
        const carSeats = parseInt(document.getElementById('car-seats').value);
        const carYear = parseInt(document.getElementById('car-year').value);
        
        // Check if car details were disabled (meaning we are only updating pricing)
        const isCarLocked = document.getElementById('car-make').disabled;

        try {
            // Photos
            let driverPhotoUrl = document.getElementById('driver-preview').src;
            if (driverPhotoUrl.startsWith('https://placehold.co')) driverPhotoUrl = "";
            
            const carPhotoUrls = [];
            for (let i = 1; i <= 3; i++) {
                const img = document.getElementById(`car-preview-${i}`);
                if (img && !img.classList.contains('hidden') && !img.src.startsWith('https://placehold.co')) {
                    carPhotoUrls.push(img.src);
                }
            }

            // Collect Fixed Pricing
            const fixedPricing = [];
            const destInputs = document.querySelectorAll('input[name="fixed-dest"]');
            const priceInputs = document.querySelectorAll('input[name="fixed-price"]');
            
            destInputs.forEach((input, index) => {
                const dest = input.value.trim();
                const amount = parseFloat(priceInputs[index].value);
                if (dest && !isNaN(amount)) {
                    fixedPricing.push({
                        destination: dest,
                        amount: amount
                    });
                }
            });

            // ATOMIC TRANSACTION: User to Driver Promotion
            await db.runTransaction(async (transaction) => {
                const uid = currentUser.uid;
                const userRef = db.collection('users').doc(uid);
                const driverRef = db.collection('kasilayn').doc('fleet').collection('drivers').doc(uid);
                const carRef = db.collection('kasilayn').doc('fleet').collection('cars').doc(carReg);

                // 1. Read User Profile
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw new Error("User profile not found.");
                const userData = userDoc.data();

                // 2. Pre-condition Check
                const driverDoc = await transaction.get(driverRef);
                const isUpdate = document.getElementById('submit-btn').textContent.includes("Update");
                if (!isUpdate && driverDoc.exists) {
                    throw new Error("ALREADY_DRIVER");
                }

                // 3. Create/Update Driver Document
                const now = firebase.firestore.FieldValue.serverTimestamp();
                const driverPayload = {
                    userRef: userRef,
                    userUid: uid,
                    username: userData.username || "",
                    email: userData.email || "",
                    displayName: userData.displayName || document.getElementById('display-name').value,
                    phone: userData.phone || userData.phoneNumber || "",
                    photoUrl: driverPhotoUrl || userData.photoUrl || "",
                    bio: userData.bio || "",
                    status: driverDoc.exists ? (driverDoc.data().status || "OFFLINE") : "OFFLINE",
                    suspended: driverDoc.exists ? (driverDoc.data().suspended || false) : false,
                    addedByUid: uid, 
                    createdAt: driverDoc.exists ? (driverDoc.data().createdAt || now) : now,
                    updatedAt: now,
                    carRegistration: carReg,
                    carRef: carRef,
                    carPhotoUrls: carPhotoUrls.length > 0 ? carPhotoUrls : (driverDoc.exists ? (driverDoc.data().carPhotoUrls || []) : [])
                };
                transaction.set(driverRef, driverPayload, { merge: true });

                // 4. Update Original User Document (Roles)
                transaction.set(userRef, {
                    roles: {
                        kasilayn: {
                            isDriver: true,
                            driverRef: `kasilayn/fleet/drivers/${uid}`
                        }
                    }
                }, { merge: true });

                // 5. Save Car Data (Atomic part of the same transaction)
                const carPayload = {
                    registration: carReg,
                    userRef: userRef, // Linked to the person adding the car
                    addedByUid: uid,
                    pricing: {
                        baseFee: parseFloat(document.getElementById('base-fee').value),
                        ratePerKm: parseFloat(document.getElementById('rate-km').value),
                        fixed: fixedPricing
                    },
                    status: 'active'
                };

                // Only update physical car details if NOT locked
                if (!isCarLocked) {
                    carPayload.make = carMake;
                    carPayload.model = carModel;
                    carPayload.color = carColor;
                    carPayload.seats = carSeats;
                    carPayload.year = carYear;
                    carPayload.bodyType = carBodyType;
                    carPayload.photoUrls = carPhotoUrls;
                    carPayload.createdAt = driverDoc.exists ? (driverDoc.data().carCreatedAt || now) : now;
                } else {
                    // If car is locked, we still might have added NEW photos if some were empty
                    carPayload.photoUrls = carPhotoUrls;
                }
                
                transaction.set(carRef, carPayload, { merge: true });
            });

            showStatus("Success! You are now officially part of the fleet.", "success");
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 2000);

        } catch (error) {
            console.error("Registration error:", error);
            if (error.message === "ALREADY_DRIVER") {
                showStatus("You are already registered as a driver.", "error");
            } else {
                showStatus("Failed to register: " + error.message, "error");
            }
        } finally {
            toggleLoader(false);
        }
    });
</script>

</body>
</html>
