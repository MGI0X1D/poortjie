<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <meta name="description" content="Manage your Poortjie Services account.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="icon" href="../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">

<header class="max-w-6xl mx-auto pt-24 pb-16 px-6 text-center">
    <a href="../index.html" onclick="window.location.replace('../index.html'); return false;" class="text-6xl font-extrabold mb-4 tracking-tight text-slate-900 dark:text-white">Poortjie</a>
</header>

<main class="max-w-md mx-auto px-6 pb-24">
    <div class="card flex flex-col p-8 rounded-2xl border-l-4 border-l-green-500">
        <h2 class="text-2xl font-bold mb-6 text-center">Your Profile</h2>
        <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-sm font-medium border"></div>
        
        <form id="profile-form">
            <div class="flex flex-col items-center mb-6">
                <div class="relative group cursor-pointer">
                    <img id="profile-picture" src="https://via.placeholder.com/150" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-green-500 shadow-md transition transform hover:scale-105">
                    <label for="photo-input" class="absolute bottom-0 right-0 bg-green-600 text-white p-2 rounded-full cursor-pointer hover:bg-green-700 transition shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </label>
                    <input type="file" id="photo-input" accept="image/*" class="hidden">
                    <input type="hidden" id="photo-url" name="photo-url">
                </div>
                <p class="text-xs opacity-50 mt-2">Click icon to change picture</p>
            </div>

            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Username (cannot be changed)</label>
                <input type="text" id="username" disabled class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 border-2 border-transparent cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Email (cannot be changed)</label>
                <input type="email" id="email" disabled class="w-full p-3 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 border-2 border-transparent cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Full Name (max 3 names)</label>
                <input type="text" id="display-name" name="display-name" placeholder="Full Name" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition" required pattern="^[A-Za-z]+(\s[A-Za-z]+){0,2}$" title="Please enter your full name (max 3 names).">
            </div>
            <div class="mb-4">
                <label class="block text-xs opacity-50 mb-1 pl-1">Phone Number (10 digits)</label>
                <input type="tel" id="phone-number" name="phone-number" placeholder="e.g. 0123456789" maxlength="10" pattern="\d{10}" title="Please enter exactly 10 digits" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition">
            </div>
            <div class="mb-6">
                <div class="flex justify-between items-center mb-1 pl-1">
                    <label class="block text-xs opacity-50">Bio / About</label>
                    <span id="bio-counter" class="text-xs opacity-50">0/100</span>
                </div>
                <textarea id="bio" name="bio" rows="3" maxlength="100" placeholder="Tell us about yourself..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition"></textarea>
            </div>
            
            <button type="submit" id="save-btn" disabled class="w-full px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md mb-4 opacity-50 cursor-not-allowed">
                Save Changes
            </button>
        </form>

        <button id="logout-btn" class="w-full px-8 py-3 border-2 border-red-500 text-red-500 font-bold rounded-lg hover:bg-red-500 hover:text-white transition">
            Logout
        </button>
    </div>
</main>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-90 transition-opacity duration-300">
    <button id="close-modal" class="absolute top-6 right-6 text-white hover:text-gray-300 focus:outline-none">
        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
    </button>
    <img id="modal-image" src="" alt="Expanded Profile Picture" class="max-w-[90%] max-h-[90%] rounded-lg shadow-2xl transform transition-transform duration-300">
</div>

<footer class="text-center py-12 border-t border-gray-100 dark:border-slate-800 opacity-50 text-xs">
    &copy; 2026 Poortjie Services. Empowering poortjie economies.
</footer>

<script src="../scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="../scripts/firebase.js"></script>

<script>
    const profileForm = document.getElementById('profile-form');
    const statusMessage = document.getElementById('status-message');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const displayNameInput = document.getElementById('display-name');
    const phoneNumberInput = document.getElementById('phone-number');
    const bioInput = document.getElementById('bio');
    const photoUrlInput = document.getElementById('photo-url');
    const photoInput = document.getElementById('photo-input');
    const profilePicture = document.getElementById('profile-picture');
    const saveBtn = document.getElementById('save-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const profileLink = document.getElementById('profile-link');
    const imageModal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const closeModal = document.getElementById('close-modal');
    const bioCounter = document.getElementById('bio-counter');

    const DEFAULT_AVATAR = "https://via.placeholder.com/150";
    let initialData = {};

    function showStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-200', 'bg-green-100', 'text-green-700', 'border-green-200');
        if (isError) {
            statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-200');
        } else {
            statusMessage.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
        }
        statusMessage.classList.remove('hidden');
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    }

    function checkChanges() {
        const currentData = {
            displayName: displayNameInput.value.trim(),
            phoneNumber: phoneNumberInput.value.trim(),
            bio: bioInput.value.trim(),
            photoUrl: photoUrlInput.value
        };

        const hasChanged = 
            currentData.displayName !== initialData.displayName ||
            currentData.phoneNumber !== initialData.phoneNumber ||
            currentData.bio !== initialData.bio ||
            currentData.photoUrl !== initialData.photoUrl;

        saveBtn.disabled = !hasChanged;
        if (saveBtn.disabled) {
            saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    [displayNameInput, phoneNumberInput, bioInput].forEach(input => {
        input.addEventListener('input', () => {
            if (input === bioInput) {
                bioCounter.textContent = `${input.value.length}/100`;
            }
            checkChanges();
        });
    });

    phoneNumberInput.addEventListener('keypress', (e) => {
        if (!/\d/.test(e.key)) {
            e.preventDefault();
        }
    });

    profilePicture.addEventListener('click', () => {
        modalImage.src = profilePicture.src;
        imageModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    closeModal.addEventListener('click', () => {
        imageModal.classList.add('hidden');
        document.body.style.overflow = '';
    });

    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            imageModal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    });

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            emailInput.value = user.email;
            firebase.firestore().collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    usernameInput.value = userData.username || '';
                    displayNameInput.value = userData.displayName || '';
                    phoneNumberInput.value = userData.phone || '';
                    bioInput.value = userData.bio || '';
                    photoUrlInput.value = userData.photoUrl || '';
                    profilePicture.src = userData.photoUrl || DEFAULT_AVATAR;

                    initialData = {
                        displayName: displayNameInput.value.trim(),
                        phoneNumber: phoneNumberInput.value.trim(),
                        bio: bioInput.value.trim(),
                        photoUrl: photoUrlInput.value
                    };
                    bioCounter.textContent = `${bioInput.value.length}/100`;
                    checkChanges();
                }
            }).catch(error => {
                console.error("Error fetching user data:", error);
                showStatus("Error loading profile data.", true);
            });
        } else {
            window.location.replace('login.html');
        }
    });

    photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Maximum dimension to keep it reasonable
                const MAX_DIM = 1200;
                if (width > height) {
                    if (width > MAX_DIM) {
                        height *= MAX_DIM / width;
                        width = MAX_DIM;
                    }
                } else {
                    if (height > MAX_DIM) {
                        width *= MAX_DIM / height;
                        height = MAX_DIM;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Start with high quality and reduce if needed
                let quality = 0.9;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Approximate size in bytes (base64 size is ~4/3 of actual size)
                while (dataUrl.length * 0.75 > 500 * 1024 && quality > 0.1) {
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                
                profilePicture.src = dataUrl;
                photoUrlInput.value = dataUrl;
                checkChanges();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const user = firebase.auth().currentUser;
        if (!user) return;

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const newDisplayName = displayNameInput.value.trim();
        const newPhoneNumber = phoneNumberInput.value.trim();
        const newBio = bioInput.value.trim();
        const newPhotoUrl = photoUrlInput.value;

        firebase.firestore().collection('users').doc(user.uid).update({
            displayName: newDisplayName,
            phoneNumber: newPhoneNumber,
            bio: newBio,
            photoUrl: newPhotoUrl,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            showStatus("Profile updated successfully!");
            // Update initialData to current values after successful save
            initialData = {
                displayName: newDisplayName,
                phoneNumber: newPhoneNumber,
                bio: newBio,
                photoUrl: newPhotoUrl
            };
            checkChanges();
            // Also update the auth profile if possible
            user.updateProfile({
                displayName: newDisplayName,
                photoURL: newPhotoUrl
            }).catch(err => console.error("Error updating auth profile:", err));
        }).catch(error => {
            console.error("Error updating profile:", error);
            showStatus("Error updating profile. Please try again.", true);
        }).finally(() => {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Changes';
        });
    });

    logoutBtn.addEventListener('click', () => {
        firebase.auth().signOut().then(() => {
            window.location.replace('../index.html');
        });
    });

    displayNameInput.addEventListener('blur', (e) => {
        let value = e.target.value.trim().replace(/\s+/g, ' ');
        if (value) {
            const words = value.split(' ');
            const formattedWords = words.slice(0, 3).map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            });
            e.target.value = formattedWords.join(' ');
        }
        checkChanges();
    });
</script>
</body>
</html>
