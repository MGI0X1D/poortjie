<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats | Poortjie Services</title>
    <meta name="author" content="Musa Mgijima">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="icon" href="favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
</head>
<body class="font-sans antialiased bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 h-screen flex flex-col">

<header class="w-full max-w-4xl mx-auto pt-6 pb-4 px-6 flex flex-col items-center shrink-0">
    <div class="w-full flex justify-between items-center">
        <a href="index.html" class="text-3xl font-extrabold tracking-tight">Poortjie</a>
        <h2 class="text-xl font-bold">Annonymouse Chats</h2>
        <div class="w-10"></div> <!-- Spacer for balance -->
    </div>
    <p class="text-sm opacity-60">say your peace</p>
</header>

<main class="flex-grow w-full max-w-4xl mx-auto px-4 pb-4 flex flex-col overflow-hidden">
    <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-4 custom-scrollbar">
        <!-- Messages will be injected here -->
        <div id="loading-spinner" class="flex justify-center items-center h-full">
            <svg class="animate-spin h-8 w-8 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
    </div>

    <!-- Reply Preview -->
    <div id="reply-preview" class="hidden bg-gray-100 dark:bg-slate-800 p-2 px-4 rounded-t-xl border-l-4 border-green-500 flex justify-between items-center mx-4">
        <div class="overflow-hidden">
            <p class="text-xs font-bold text-green-600 dark:text-green-400">Replying to <span id="reply-to-name"></span></p>
            <p id="reply-to-text" class="text-sm opacity-70 truncate"></p>
        </div>
        <button id="cancel-reply" class="text-gray-500 hover:text-red-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Message Input -->
    <div class="p-4 bg-white dark:bg-slate-900 border-t dark:border-slate-800 shrink-0">
        <form id="chat-form" class="flex gap-2 items-end">
            <div class="flex-grow">
                <textarea id="message-input" rows="1" placeholder="Type a message..." 
                    class="w-full p-3 rounded-2xl bg-gray-100 dark:bg-slate-800 text-gray-900 dark:text-white border-2 border-transparent focus:border-green-500 focus:outline-none transition resize-none max-h-32"></textarea>
            </div>
            <button type="submit" id="send-btn" 
                class="p-3 bg-green-600 text-white rounded-full hover:bg-green-700 transition shadow-md disabled:opacity-50">
                <svg class="w-6 h-6 transform rotate-90" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
            </button>
        </form>
    </div>
</main>

<script src="scripts/theme.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="scripts/firebase.js"></script>

<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const replyPreview = document.getElementById('reply-preview');
    const replyToName = document.getElementById('reply-to-name');
    const replyToText = document.getElementById('reply-to-text');
    const cancelReplyBtn = document.getElementById('cancel-reply');
    const loadingSpinner = document.getElementById('loading-spinner');

    let currentUser = null;
    let userData = null;
    let userMaskName = null;
    let replyingTo = null;

    function generateMaskName(uid) {
        // Create a deterministic random-looking string of letters based on UID
        let hash = 0;
        for (let i = 0; i < uid.length; i++) {
            hash = uid.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const chars = 'abcdefghijklmnopqrstuvwxyz';
        let result = '';
        // Use the hash to pick 8 characters
        for (let i = 0; i < 8; i++) {
            const charIndex = Math.abs(hash + i * 13) % chars.length;
            result += chars[charIndex];
        }
        return result;
    }

    // Check auth state
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.replace('authentication/login.html');
            return;
        }
        currentUser = user;
        userMaskName = generateMaskName(user.uid);
        
        // Fetch user data for display name
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            userData = userDoc.data();
        } else {
            userData = { displayName: user.displayName || user.email.split('@')[0] };
        }

        initChat();
    });

    function initChat() {
        // Real-time listener for messages
        db.collection('group_chats').doc('main').collection('messages')
            .orderBy('timestamp', 'asc')
            .limitToLast(100)
            .onSnapshot(snapshot => {
                loadingSpinner.classList.add('hidden');
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderMessage(change.doc);
                    } else if (change.type === 'modified') {
                        updateMessageUI(change.doc);
                    }
                });
                scrollToBottom();
            }, error => {
                console.error("Chat listener error:", error);
                chatMessages.innerHTML = `<p class="text-center text-red-500">Error loading messages. Please refresh.</p>`;
            });
    }

    function renderMessage(doc) {
        const msg = doc.data();
        const msgId = doc.id;
        const isMine = msg.userId === currentUser.uid;
        const senderMaskName = generateMaskName(msg.userId);
        
        const messageDiv = document.createElement('div');
        messageDiv.id = `msg-${msgId}`;
        messageDiv.className = `flex flex-col ${isMine ? 'items-end' : 'items-start'} group mb-4`;
        
        const timestamp = msg.timestamp ? msg.timestamp.toDate() : new Date();
        const time = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const date = timestamp.toLocaleDateString([], { month: 'short', day: 'numeric' });
        const fullTimeDisplay = `${date}, ${time}`;
        
        let replyHtml = '';
        if (msg.replyTo) {
            const replyMaskName = generateMaskName(msg.replyTo.userId);
            replyHtml = `
                <div class="bg-black/5 dark:bg-white/5 p-2 rounded-lg mb-1 text-xs border-l-2 border-green-500 max-w-full opacity-80">
                    <p class="font-bold">${replyMaskName}</p>
                    <p class="truncate">${msg.replyTo.text}</p>
                </div>
            `;
        }

        const thumbsUpCount = msg.thumbsUp ? Object.keys(msg.thumbsUp).length : 0;
        const thumbsDownCount = msg.thumbsDown ? Object.keys(msg.thumbsDown).length : 0;
        const isThumbsUp = msg.thumbsUp && msg.thumbsUp[currentUser.uid];
        const isThumbsDown = msg.thumbsDown && msg.thumbsDown[currentUser.uid];

        messageDiv.innerHTML = `
            ${!isMine ? `<span class="text-[10px] font-bold opacity-50 mb-1 ml-2 uppercase tracking-wider">${senderMaskName}</span>` : ''}
            <div class="relative max-w-[85%] sm:max-w-[70%]">
                <div class="${isMine ? 'bg-green-600 text-white rounded-2xl rounded-tr-none' : 'bg-gray-100 dark:bg-slate-800 rounded-2xl rounded-tl-none'} p-3 shadow-sm">
                    ${replyHtml}
                    <p class="text-sm whitespace-pre-wrap break-words">${msg.text}</p>
                    <div class="flex items-center justify-end gap-2 mt-1 opacity-50 text-[10px]">
                        <span>${fullTimeDisplay}</span>
                    </div>
                </div>
                
                <!-- Action buttons -->
                <div class="absolute top-0 ${isMine ? '-left-16' : '-right-16'} hidden group-hover:flex flex-col gap-1">
                    <button onclick="setReply('${msgId}', '${msg.userId}', '${msg.text.replace(/'/g, "\\'").replace(/\n/g, " ")}')" class="p-1.5 bg-white dark:bg-slate-700 rounded-full shadow-md hover:bg-green-100 dark:hover:bg-green-900 transition text-gray-600 dark:text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                    </button>
                    <button onclick="toggleReaction('${msgId}', 'thumbsUp')" class="p-1.5 bg-white dark:bg-slate-700 rounded-full shadow-md hover:bg-green-100 dark:hover:bg-green-900 transition ${isThumbsUp ? 'text-green-500' : 'text-gray-600 dark:text-gray-300'}">
                        <svg class="w-4 h-4" fill="${isThumbsUp ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.708C19.746 10 20.621 10.772 20.621 11.723c0 .38-.117.74-.326 1.042l-2.618 3.766A2.43 2.43 0 0115.688 18H9a1 1 0 01-1-1v-7a1 1 0 01.293-.707l5.414-5.414A1 1 0 0114.414 3.586V10zM3 18V10h4v8H3z"></path></svg>
                    </button>
                    <button onclick="toggleReaction('${msgId}', 'thumbsDown')" class="p-1.5 bg-white dark:bg-slate-700 rounded-full shadow-md hover:bg-red-100 dark:hover:bg-red-900 transition ${isThumbsDown ? 'text-red-500' : 'text-gray-600 dark:text-gray-300'}">
                        <svg class="w-4 h-4" fill="${isThumbsDown ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.292C4.254 14 3.379 13.228 3.379 12.277c0-.38.117-.74.326-1.042l2.618-3.766A2.43 2.43 0 017.312 6H14a1 1 0 011 1v7a1 1 0 01-.293.707l-5.414 5.414a1 1 0 01-.707.293V14zM21 6v8h-4V6h4z"></path></svg>
                    </button>
                </div>

                <div class="absolute -bottom-2 ${isMine ? 'right-0' : 'left-0'} flex gap-1">
                    ${thumbsUpCount > 0 ? `
                        <div class="bg-white dark:bg-slate-700 rounded-full px-1.5 py-0.5 shadow-sm border border-gray-100 dark:border-slate-600 flex items-center gap-1 text-[10px]">
                            <span>üëç</span>
                            <span class="font-bold">${thumbsUpCount}</span>
                        </div>
                    ` : ''}
                    ${thumbsDownCount > 0 ? `
                        <div class="bg-white dark:bg-slate-700 rounded-full px-1.5 py-0.5 shadow-sm border border-gray-100 dark:border-slate-600 flex items-center gap-1 text-[10px]">
                            <span>üëé</span>
                            <span class="font-bold">${thumbsDownCount}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
    }

    function updateMessageUI(doc) {
        const msg = doc.data();
        const msgId = doc.id;
        const messageDiv = document.getElementById(`msg-${msgId}`);
        if (!messageDiv) return;

        const isMine = msg.userId === currentUser.uid;
        
        const thumbsUpCount = msg.thumbsUp ? Object.keys(msg.thumbsUp).length : 0;
        const thumbsDownCount = msg.thumbsDown ? Object.keys(msg.thumbsDown).length : 0;
        const isThumbsUp = msg.thumbsUp && msg.thumbsUp[currentUser.uid];
        const isThumbsDown = msg.thumbsDown && msg.thumbsDown[currentUser.uid];

        // Update reaction buttons
        const upBtn = messageDiv.querySelector('button[onclick*="thumbsUp"]');
        if (upBtn) {
            upBtn.className = `p-1.5 bg-white dark:bg-slate-700 rounded-full shadow-md hover:bg-green-100 dark:hover:bg-green-900 transition ${isThumbsUp ? 'text-green-500' : 'text-gray-600 dark:text-gray-300'}`;
            upBtn.querySelector('svg').setAttribute('fill', isThumbsUp ? 'currentColor' : 'none');
        }

        const downBtn = messageDiv.querySelector('button[onclick*="thumbsDown"]');
        if (downBtn) {
            downBtn.className = `p-1.5 bg-white dark:bg-slate-700 rounded-full shadow-md hover:bg-red-100 dark:hover:bg-red-900 transition ${isThumbsDown ? 'text-red-500' : 'text-gray-600 dark:text-gray-300'}`;
            downBtn.querySelector('svg').setAttribute('fill', isThumbsDown ? 'currentColor' : 'none');
        }

        // Update indicators
        let indicatorsContainer = messageDiv.querySelector('.absolute.-bottom-2');
        if (!indicatorsContainer) {
            indicatorsContainer = document.createElement('div');
            indicatorsContainer.className = `absolute -bottom-2 ${isMine ? 'right-0' : 'left-0'} flex gap-1`;
            messageDiv.querySelector('.relative').appendChild(indicatorsContainer);
        }

        indicatorsContainer.innerHTML = `
            ${thumbsUpCount > 0 ? `
                <div class="bg-white dark:bg-slate-700 rounded-full px-1.5 py-0.5 shadow-sm border border-gray-100 dark:border-slate-600 flex items-center gap-1 text-[10px]">
                    <span>üëç</span>
                    <span class="font-bold">${thumbsUpCount}</span>
                </div>
            ` : ''}
            ${thumbsDownCount > 0 ? `
                <div class="bg-white dark:bg-slate-700 rounded-full px-1.5 py-0.5 shadow-sm border border-gray-100 dark:border-slate-600 flex items-center gap-1 text-[10px]">
                    <span>üëé</span>
                    <span class="font-bold">${thumbsDownCount}</span>
                </div>
            ` : ''}
        `;
    }

    function setReply(msgId, userId, text) {
        const maskName = generateMaskName(userId);
        replyingTo = { msgId, userId, maskName, text };
        replyToName.textContent = maskName;
        replyToText.textContent = text;
        replyPreview.classList.remove('hidden');
        messageInput.focus();
    }

    cancelReplyBtn.onclick = () => {
        replyingTo = null;
        replyPreview.classList.add('hidden');
    };

    function toggleReaction(msgId, type) {
        const msgRef = db.collection('group_chats').doc('main').collection('messages').doc(msgId);
        
        db.runTransaction(async (transaction) => {
            const doc = await transaction.get(msgRef);
            if (!doc.exists) return;
            
            const data = doc.data();
            const reactions = data[type] || {};
            const oppositeType = type === 'thumbsUp' ? 'thumbsDown' : 'thumbsUp';
            const oppositeReactions = data[oppositeType] || {};

            if (reactions[currentUser.uid]) {
                delete reactions[currentUser.uid];
            } else {
                reactions[currentUser.uid] = true;
                // Remove opposite reaction if it exists
                if (oppositeReactions[currentUser.uid]) {
                    delete oppositeReactions[currentUser.uid];
                }
            }
            
            transaction.update(msgRef, { 
                [type]: reactions,
                [oppositeType]: oppositeReactions
            });
        });
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        const msgData = {
            userId: currentUser.uid,
            userName: userMaskName,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            thumbsUp: {},
            thumbsDown: {}
        };

        if (replyingTo) {
            msgData.replyTo = {
                msgId: replyingTo.msgId,
                userId: replyingTo.userId,
                userName: replyingTo.maskName,
                text: replyingTo.text
            };
            replyingTo = null;
            replyPreview.classList.add('hidden');
        }

        try {
            await db.collection('group_chats').doc('main').collection('messages').add(msgData);
        } catch (error) {
            console.error("Error sending message:", error);
            alert("Failed to send message.");
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    function scrollToBottom() {
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    }
</script>
</body>
</html>
